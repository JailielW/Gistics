@page "/todos/new"
@page "/todos/edit/{Id:guid}"
@using System.ComponentModel.DataAnnotations
@using Gistics.Models
@inject Gistics.Services.ITodoService TodoService
@inject NavigationManager Navigation

<h3>@(isNew ? "New Todo" : "Edit Todo")</h3>

<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Title</label>
        <InputText class="form-control" @bind-Value="model.Title" />
        <ValidationMessage For="@(() => model.Title)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Description</label>
        <InputTextArea class="form-control" rows="4" @bind-Value="model.Description" />
        <ValidationMessage For="@(() => model.Description)" />
    </div>

    <div class="form-check mb-3">
        <InputCheckbox class="form-check-input" @bind-Value="model.IsCompleted" />
        <label class="form-check-label">Completed</label>
    </div>

    <button class="btn btn-primary" type="submit">Save</button>
    <button class="btn btn-secondary ms-2" type="button" @onclick="Cancel">Cancel</button>
</EditForm>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private TodoItem model = new();
    private bool isNew => Id == null;

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            var item = await TodoService.GetAsync(Id.Value);
            if (item != null)
            {
                model = item;
            }
            else
            {
                // Not found: navigate back to list
                Navigation.NavigateTo("/todos");
            }
        }
        else
        {
            model = new TodoItem();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (isNew)
        {
            await TodoService.CreateAsync(model);
        }
        else
        {
            await TodoService.UpdateAsync(model);
        }

        Navigation.NavigateTo("/todos");
    }

    private void Cancel() => Navigation.NavigateTo("/todos");
}